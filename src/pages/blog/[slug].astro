---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { BRAND } from '../../data/brand';
import { BLOG_POSTS, getRecentPosts, type BlogPost } from '../../data/blog';
import { getBreadcrumbSchema, getBlogArticleSchema, getBaseBusinessSchema, serializeSchema } from '../../utils/schema';

export function getStaticPaths() {
  return BLOG_POSTS.map((post) => ({
    params: { slug: post.slug },
    props: { post }
  }));
}

interface Props {
  post: BlogPost;
}

const { post } = Astro.props;

const breadcrumbSchema = getBreadcrumbSchema([
  { name: "Home", url: "/" },
  { name: "Blog", url: "/blog/" },
  { name: post.title, url: `/blog/${post.slug}/` }
]);

const articleSchema = getBlogArticleSchema(post);
const businessSchema = getBaseBusinessSchema();

const recentPosts = getRecentPosts(3).filter(p => p.slug !== post.slug).slice(0, 3);

function formatDate(dateString: string): string {
  return new Date(dateString).toLocaleDateString('en-GB', {
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  });
}

// Convert markdown-style headings and paragraphs to HTML
function formatContent(content: string): string {
  return content
    .split('\n\n')
    .map(paragraph => {
      // Handle headings
      if (paragraph.startsWith('## ')) {
        return `<h2 class="text-2xl font-bold mt-8 mb-4">${paragraph.replace('## ', '')}</h2>`;
      }
      if (paragraph.startsWith('### ')) {
        return `<h3 class="text-xl font-semibold mt-6 mb-3">${paragraph.replace('### ', '')}</h3>`;
      }
      // Handle lists
      if (paragraph.includes('\n- ')) {
        const items = paragraph.split('\n- ').filter(Boolean);
        const listItems = items.map(item => `<li class="ml-4">${item.replace(/^\- /, '')}</li>`).join('');
        return `<ul class="list-disc pl-6 mb-4 space-y-2">${listItems}</ul>`;
      }
      // Handle numbered lists
      if (paragraph.match(/^\d\. /)) {
        const items = paragraph.split('\n').filter(Boolean);
        const listItems = items.map(item => `<li class="ml-4">${item.replace(/^\d\. /, '')}</li>`).join('');
        return `<ol class="list-decimal pl-6 mb-4 space-y-2">${listItems}</ol>`;
      }
      // Regular paragraphs
      return `<p class="text-muted-foreground mb-4 leading-relaxed">${paragraph}</p>`;
    })
    .join('')
    // Convert markdown links [text](url) to HTML anchor tags
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" class="text-primary hover:underline font-medium">$1</a>');
}
---

<BaseLayout
  title={post.metaTitle}
  description={post.metaDescription}
  canonical={`/blog/${post.slug}/`}
  schema={[businessSchema, articleSchema]}
>
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />

  <!-- Article Header -->
  <section class="hero-section">
    <div class="hero-overlay py-16 md:py-20">
      <div class="container-narrow px-4 text-center text-white">
        <div class="flex items-center justify-center gap-2 mb-4">
          <span class="text-sm font-medium bg-white/20 px-3 py-1 rounded-full">
            {post.category}
          </span>
          <span class="text-sm text-white/80">
            {post.readingTime} min read
          </span>
        </div>
        <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold mb-4">{post.title}</h1>
        <div class="flex items-center justify-center gap-4 text-white/80 text-sm">
          <span>By {post.author}</span>
          <span>â€¢</span>
          <time datetime={post.publishDate}>{formatDate(post.publishDate)}</time>
        </div>
      </div>
    </div>
  </section>

  <!-- Breadcrumbs -->
  <nav class="bg-muted/50 border-b border-border" aria-label="Breadcrumb">
    <div class="container-narrow px-4 py-3">
      <ol class="flex items-center gap-2 text-sm text-muted-foreground">
        <li><a href="/" class="hover:text-primary transition-colors">Home</a></li>
        <li><span class="mx-2">/</span></li>
        <li><a href="/blog/" class="hover:text-primary transition-colors">Blog</a></li>
        <li><span class="mx-2">/</span></li>
        <li class="text-foreground font-medium truncate max-w-[200px]">{post.title}</li>
      </ol>
    </div>
  </nav>

  <!-- Article Content -->
  <article class="section-padding">
    <div class="container-narrow px-4">
      <div class="prose prose-lg max-w-none" set:html={formatContent(post.content)} />

      <!-- Tags -->
      <div class="mt-10 pt-6 border-t border-border">
        <div class="flex flex-wrap gap-2">
          {post.tags.map((tag) => (
            <span class="text-sm bg-muted text-muted-foreground px-3 py-1 rounded-full">
              #{tag.replace(/\s+/g, '')}
            </span>
          ))}
        </div>
      </div>
    </div>
  </article>

  <!-- Related Posts -->
  {recentPosts.length > 0 && (
    <section class="section-padding bg-muted/50">
      <div class="container-wide px-4">
        <h2 class="text-2xl font-bold mb-8 text-center">More Articles</h2>
        <div class="grid md:grid-cols-3 gap-6">
          {recentPosts.map((relatedPost) => (
            <article class="bg-white border border-border rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow">
              <div class="p-5">
                <span class="text-xs font-medium text-primary bg-primary/10 px-2 py-1 rounded">
                  {relatedPost.category}
                </span>
                <h3 class="text-lg font-bold mt-3 mb-2 line-clamp-2">
                  <a href={`/blog/${relatedPost.slug}/`} class="hover:text-primary transition-colors">
                    {relatedPost.title}
                  </a>
                </h3>
                <p class="text-muted-foreground text-sm line-clamp-2">
                  {relatedPost.excerpt}
                </p>
              </div>
            </article>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- CTA Section -->
  <section class="section-padding bg-primary text-primary-foreground">
    <div class="container-wide px-4 text-center">
      <h2 class="text-3xl font-bold mb-4">Need Professional Help?</h2>
      <p class="text-xl text-primary-foreground/90 mb-8 max-w-2xl mx-auto">
        Our expert drainage team is available 24/7 across Manchester and Greater Manchester.
      </p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a href={`tel:${BRAND.phone}`} class="bg-white text-primary font-semibold px-8 py-4 rounded-lg shadow-lg hover:bg-white/90 transition-all text-lg">
          Call {BRAND.phoneFormatted}
        </a>
        <a href="/contact/" class="border-2 border-white text-white font-semibold px-8 py-4 rounded-lg hover:bg-white/10 transition-all text-lg">
          Get a Quote
        </a>
      </div>
    </div>
  </section>
</BaseLayout>
