---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import HeroWithLeadForm from '../../../components/HeroWithLeadForm.astro';
import Breadcrumbs from '../../../components/Breadcrumbs.astro';
import { LOCATIONS, getLocationBySlug } from '../../../data/locations';
import { SERVICES, getServiceBySlug } from '../../../data/services';
import { BRAND } from '../../../data/brand';
import { getRelatedBlogPosts } from '../../../data/blog';
import { getBreadcrumbSchema, getLocationServicePageSchema, getFAQSchema } from '../../../utils/schema';
import {
  getLocationServiceContent,
  getLocationData,
  getLocationServiceFAQs,
  interpolateLocationText,
  SERVICE_HOW_IT_WORKS,
  SERVICE_WHY_CHOOSE_US,
} from '../../../data/locationServiceContent';

export async function getStaticPaths() {
  return LOCATIONS.flatMap((location) =>
    SERVICES.map((service) => ({ params: { location: location.slug, service: service.slug } })),
  );
}

const location = getLocationBySlug(Astro.params.location || '');
const service = getServiceBySlug(Astro.params.service || '');
if (!location || !service) return Astro.redirect('/locations/');

const content = getLocationServiceContent(location.slug, service.slug);
const locationData = getLocationData(location.slug);
const howItWorks = SERVICE_HOW_IT_WORKS[service.slug] || [];
const whyChooseUsBullets = SERVICE_WHY_CHOOSE_US[service.slug] || [];
const faqs = getLocationServiceFAQs(location.slug, service.slug);
const blogPosts = getRelatedBlogPosts(service.slug);

function interpolate(text: string): string {
  return interpolateLocationText(text, location!.name, locationData, content);
}

const title = `${service.name} ${location.name} | Fast Response | No Call-Out Fee`;
const description = `${service.shortLabel} in ${location.name}. No call-out fee, fixed pricing, 24/7 availability. Call ${BRAND.phoneFormatted} for fast local support.`;
const pageSchema = [
  ...getLocationServicePageSchema(location, service),
  getBreadcrumbSchema([
    { name: 'Home', url: '/' },
    { name: 'Locations', url: '/locations/' },
    { name: location.name, url: `/locations/${location.slug}/` },
    { name: service.name, url: `/locations/${location.slug}/${service.slug}/` },
  ]),
  ...(faqs.length > 0 ? [getFAQSchema(faqs)] : []),
];
---

<BaseLayout title={title} description={description} canonical={`/locations/${location.slug}/${service.slug}/`} schema={pageSchema} noindex={!!location.noindex}>
  <HeroWithLeadForm
    title={`${service.name} in ${location.name}`}
    description={`${service.description} Available across ${location.name} with responsive local callouts.`}
    formId={`location-service-${location.slug}-${service.slug}-lead-form`}
    source={`location-service:${location.slug}/${service.slug}`}
  />

  <Breadcrumbs items={[
    { name: 'Home', url: '/' },
    { name: 'Locations', url: '/locations/' },
    { name: location.name, url: `/locations/${location.slug}/` },
    { name: service.name },
  ]} />

  {/* Intro section */}
  {content && (
    <section class="section-padding bg-white">
      <div class="container-wide px-4">
        <div class="max-w-3xl">
          <h2 class="text-2xl md:text-3xl font-bold mb-4">{service.name} in {location.name}</h2>
          <p class="text-muted-foreground leading-relaxed">{content.intro}</p>
        </div>
      </div>
    </section>
  )}

  {/* How It Works section */}
  {howItWorks.length > 0 && (
    <section class="section-padding">
      <div class="container-wide px-4">
        <h2 class="text-2xl md:text-3xl font-bold mb-8">How {service.name.toLowerCase()} works in {location.name}</h2>
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {howItWorks.map((step, i) => (
            <div class="bg-card p-6 rounded-xl border border-border shadow-sm">
              <div class="text-2xl font-bold text-primary mb-2">{i + 1}</div>
              <h3 class="text-lg font-bold mb-2">{step.title}</h3>
              <p class="text-muted-foreground text-sm">{interpolate(step.description)}</p>
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  {/* Common Problems & Our Process section */}
  {content && (
    <section class="section-padding bg-white">
      <div class="container-wide px-4 grid md:grid-cols-2 gap-8">
        <article class="bg-card p-6 rounded-xl border border-border shadow-sm">
          <h2 class="text-xl font-bold mb-4">Common {service.name.toLowerCase()} problems in {location.name}</h2>
          <ul class="space-y-2">
            {content.commonProblems.map((problem) => (
              <li class="flex items-start gap-2">
                <span class="text-primary mt-1 shrink-0">&#10003;</span>
                <span class="text-muted-foreground">{problem}</span>
              </li>
            ))}
          </ul>
        </article>
        <article class="bg-card p-6 rounded-xl border border-border shadow-sm">
          <h2 class="text-xl font-bold mb-4">Our approach in {location.name}</h2>
          <p class="text-muted-foreground mb-3">{content.process}</p>
          <p class="text-muted-foreground"><strong>Local tip:</strong> {content.localTip}</p>
        </article>
      </div>
    </section>
  )}

  {/* Why Choose Us section */}
  {whyChooseUsBullets.length > 0 && (
    <section class="section-padding">
      <div class="container-wide px-4">
        <div class="max-w-3xl">
          <h2 class="text-2xl md:text-3xl font-bold mb-6">Why choose us for {service.name.toLowerCase()} in {location.name}</h2>
          <ul class="space-y-3">
            {whyChooseUsBullets.map((bullet) => (
              <li class="flex items-start gap-3">
                <span class="text-primary mt-1 shrink-0">&#10003;</span>
                <span class="text-muted-foreground">{interpolate(bullet)}</span>
              </li>
            ))}
          </ul>
        </div>
      </div>
    </section>
  )}

  {/* FAQ section */}
  {faqs.length > 0 && (
    <section class="section-padding bg-white">
      <div class="container-wide px-4">
        <h2 class="text-2xl md:text-3xl font-bold mb-8">{service.name} in {location.name} â€” FAQs</h2>
        <div class="max-w-3xl mx-auto space-y-4">
          {faqs.map((faq, i) => (
            <details class="bg-card rounded-lg card-elevated group" open={i === 0}>
              <summary class="p-4 md:p-6 cursor-pointer font-semibold text-lg hover:text-primary transition-colors flex items-center justify-between">
                {faq.question}
                <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="shrink-0 ml-2 group-open:rotate-180 transition-transform"><path d="m6 9 6 6 6-6"></path></svg>
              </summary>
              <div class="px-4 md:px-6 pb-4 md:pb-6 text-muted-foreground"><p>{faq.answer}</p></div>
            </details>
          ))}
        </div>
      </div>
    </section>
  )}

  {blogPosts.length > 0 && (
    <section class="section-padding bg-white">
      <div class="container-wide px-4">
        <h2 class="text-2xl md:text-3xl font-bold mb-8">Helpful articles</h2>
        <div class="grid md:grid-cols-2 gap-6">
          {blogPosts.map((post) => (
            <a class="bg-card p-6 rounded-xl border border-border shadow-sm hover:shadow-md hover:border-primary transition-all no-underline text-foreground" href={`/blog/${post.slug}/`}>
              <span class="text-xs font-medium text-primary bg-primary/10 px-2 py-1 rounded">{post.category}</span>
              <h3 class="text-lg font-bold mt-3 mb-2">{post.title}</h3>
              <p class="text-muted-foreground text-sm">{post.excerpt}</p>
            </a>
          ))}
        </div>
      </div>
    </section>
  )}

  {/* Related pages */}
  <section class="section-padding">
    <div class="container-wide px-4 grid md:grid-cols-2 gap-8">
      <article class="bg-card p-6 rounded-xl border border-border shadow-sm">
        <h2 class="text-xl font-bold mb-4">Why customers in {location.name} book this service</h2>
        <ul>
          <li>Fast attendance for urgent drainage issues</li>
          <li>Clear communication and fixed pricing options</li>
          <li>Equipment suited to domestic and commercial work</li>
        </ul>
      </article>
      <article class="bg-card p-6 rounded-xl border border-border shadow-sm">
        <h2 class="text-xl font-bold mb-4">Related pages</h2>
        <div class="grid gap-3">
          <a href={`/services/${service.slug}/`}>Read full {service.name} service details</a>
          <a href={`/locations/${location.slug}/`}>See all drainage services in {location.name}</a>
        </div>
      </article>
    </div>
  </section>
</BaseLayout>
